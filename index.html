<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Army Of Morr</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
</head>
<body>
    <div id="stats">
        <p id="life"></p>
        <p id="time"></p>
    </div>

    <!-- Game code -->
    <script>
    //CONFIGURATION & VARIABLES
        var config = {
            type: Phaser.AUTO,
            width: 640,
            height: 1200,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: true,
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };
    
        var game = new Phaser.Game(config)
        var player, cursors, enemy, fireball

        //Player stats
        var playerStats = {
            life: 100,
            speed: 200,
            points: 0,
            experiece: 0,
            weapons:{
                fireball: {
                    equiped: true,
                    direction: 'top', 
                    damage: 5,
                    castSpeed: 1600,
                    projSpeed: 360,
                    dpsTimeout: 500, //how frequently projectile deals damage
                }
            }
        }

        var enemyGroup = {
            speed: 80
        }

    //PRELOAD
        function preload (){
            //Player
            this.load.image('player', './img/player.png')

            //Enemy
            this.load.image('enemy-1', './img/enemy-1.png')
            this.load.image('enemy-1-hit', './img/enemy-1-hit.png');
        
            //Misc
            this.load.image('map', './img/map.png')

            this.load.image('fireball', './img/fireball.png')
        }
    
    //CREATE
        function create (){
            //Variables for screen centre
            const screenCenterX = this.cameras.main.worldView.x + this.cameras.main.width / 2;
            const screenCenterY = this.cameras.main.worldView.y + this.cameras.main.height / 2;

            //Background image
            this.add.image(375, 812, 'map')

            //Player sprite
            player = this.physics.add.sprite(screenCenterX, screenCenterY, 'player')
            player.setCollideWorldBounds(true);

            //Enemy sprite
            enemy = this.physics.add.group();
            
            setInterval(function()
            {
                let screenX = config.width
                let screenY = config.height
                let unitSize = 80

                if(Math.floor(Math.random()* 10) > 5){
                    enemy.create(
                        (Phaser.Math.Between(-80,-600)),
                        (Phaser.Math.Between(1000,600)), //y
                        'enemy-1'
                    )
                }
                else {
                    enemy.create(
                        (Phaser.Math.Between(600,-80)),
                        (Phaser.Math.Between(-80,-80)), //y
                        'enemy-1'
                    )
                }

                //Add custom properties to calculate dmg
                var lastEnemy = enemy.children.entries[enemy.children.entries.length - 1]
                lastEnemy.customHp = Math.floor(Math.random() * 10)
                lastEnemy.customHp = 10
                lastEnemy.lastHitTime = Date.now()
            }, 2000)

            //Projectiles
            //Fireball
            fireball = this.physics.add.group({
                key: 'fireball',
                repeat: 0,
                setXY: {x:9999, y:9999}
            })
            
            setInterval(function(){
                if(playerStats.weapons.fireball.equiped === true){
                    
                    if(playerStats.weapons.fireball.direction === 1){
                        fireball.children.entries.forEach(function (fireball){                 
                            fireball.x = player.x
                            fireball.y = player.y  
                            fireball.angle = 90

                            fireball.setVelocityY(-Math.abs(playerStats.weapons.fireball.projSpeed))
                            fireball.setVelocityX(0)

                            playerStats.weapons.fireball.direction = 2
                        })
                    }
                    else if(playerStats.weapons.fireball.direction === 2){
                        fireball.children.entries.forEach(function (fireball){                 
                            fireball.x = player.x
                            fireball.y = player.y  
                            fireball.angle = 180
                            fireball.setVelocityY(0)
                            fireball.setVelocityX(playerStats.weapons.fireball.projSpeed)

                            playerStats.weapons.fireball.direction = 3
                        })
                    }
                    else if(playerStats.weapons.fireball.direction === 3){
                        fireball.children.entries.forEach(function (fireball){                 
                            fireball.x = player.x
                            fireball.y = player.y  
                            fireball.angle = 270
                            
                            fireball.setVelocityY(playerStats.weapons.fireball.projSpeed)
                            fireball.setVelocityX(0)

                            playerStats.weapons.fireball.direction = 4
                        })
                    }
                    else if (playerStats.weapons.fireball.direction === 4) {
                        fireball.children.entries.forEach(function (fireball){                 
                            fireball.x = player.x
                            fireball.y = player.y  
                            fireball.angle = 0

                            fireball.setVelocityY(0)
                            fireball.setVelocityX(-Math.abs(playerStats.weapons.fireball.projSpeed))

                            playerStats.weapons.fireball.direction = 1
                        })
                    }
                    else if (playerStats.weapons.fireball.direction === 'top'){
                        fireball.children.entries.forEach(function (fireball){                 
                            fireball.x = player.x
                            fireball.y = player.y  
                            fireball.angle = 90

                            fireball.setVelocityY(-Math.abs(playerStats.weapons.fireball.projSpeed))
                            fireball.setVelocityX(0)
                        })
                    }
                }
            }, playerStats.weapons.fireball.castSpeed);
            
            //Keyboard keys
            cursors = this.input.keyboard.createCursorKeys()

            //Colliders
            this.physics.add.overlap(player, enemy, dmgPlayer, null, this)  //Player vs enemy
            this.physics.add.overlap(fireball, enemy, dmgEnemy, null, this) //Fireball vs enemy
            this.physics.add.collider(enemy, enemy) //Enemy vs Enemy

            //Points calculation function
            var timeText = document.getElementById('time')
            timeText.innerHTML = "0 point"

            setInterval(function(){
                //Update timer
                playerStats.points++
                timeText.innerHTML = playerStats.points + " points"
            }, 1000);
        }
        
    //UPDATE
        function update (){
            
            //Player movement wihth keyboard
            if (cursors.left.isDown) {
                // player.x -= 3
                player.setVelocityX(-Math.abs(playerStats.speed))

                //Turn drift
                if(player.body.velocity.y > 0){
                    player.setVelocityY(player.body.velocity.y - 5)
                }
                else if (player.body.velocity.y < 0) {
                    player.setVelocityY(player.body.velocity.y + 5)
                }
            }
            else if (cursors.right.isDown) {
                player.setVelocityX(playerStats.speed)

                //Turn drift
                if(player.body.velocity.y > 0){
                    player.setVelocityY(player.body.velocity.y - 5)
                }
                else if (player.body.velocity.y < 0) {
                    player.setVelocityY(player.body.velocity.y + 5)
                }
            }
            else if (cursors.up.isDown) {
                player.setVelocityY(-Math.abs(playerStats.speed))

                if(player.body.velocity.x > 0){
                    player.setVelocityX(player.body.velocity.x - 5)
                }
                else if (player.body.velocity.x < 0) {
                    player.setVelocityX(player.body.velocity.x + 5)
                }
            }
            else if (cursors.down.isDown) {
                player.setVelocityY(playerStats.speed)

                if(player.body.velocity.x > 0){
                    player.setVelocityX(player.body.velocity.x - 5)
                } 
                else if (player.body.velocity.x < 0) {
                    player.setVelocityX(player.body.velocity.x + 5)
                }
            }
            else {
                player.setVelocityX(0)
                player.setVelocityY(0)
            }

            //Enemy movement
            enemy.children.entries.forEach(function(element){

                if (player.x - 25 > element.x){
                    element.setVelocityX(enemyGroup.speed)
                }
                else if (player.x + 25 < element.x){
                    element.setVelocityX(-Math.abs(enemyGroup.speed))
                }
                else{
                    element.setVelocityX(0)
                }
    
                if (player.y - 25 > element.y){
                    element.setVelocityY(enemyGroup.speed)
                }
                else if (player.y + 25 < element.y){
                    element.setVelocityY(-Math.abs(enemyGroup.speed))
                }
                else {
                    element.setVelocityY(0)
                }
            })
        }
    
    //GAME LOGIC
        //Player damage
        var lastRun = 0
        var delay = 500

        var lifeText = document.getElementById('life')
        lifeText.innerHTML = playerStats.life //Set life value to obj value

        function dmgPlayer(player, enemy){
            
            //Prevent function from executing more than N times per sec.
            if (lastRun > (Date.now() - delay))
                //Timer
                return;
                lastRun = Date.now();
                
                //Reduce live
                playerStats.life--

                //Check if player is dead
                if(playerStats.life < 1){

                    //Reset player object
                    playerStats.life = 10
                    playerStats.points = 0

                    //Restart the game
                    this.scene.restart();
                }

                //Update html life label
                lifeText.innerHTML = playerStats.life

                //Change player colour to black on overlap
                player.tint = 0x121212

                //Reset player to white after delay
                setTimeout(function(){ player.tint = 0xffffff; }, 100);
        }

        
        //ENEMY DAMAGE
        function dmgEnemy(fireball, enemy){

            var enemyHp = enemy.customHp
            var weaponDmg = playerStats.weapons.fireball.damage

            //Enemy dead
            if (Date.now() - enemy.lastHitTime > playerStats.weapons.fireball.dpsTimeout){
                enemy.lastHitTime = Date.now()

                if(enemyHp <= weaponDmg){
                    dropExp(enemy)
                    enemy.destroy()
                }
                //Enemy hit
                else{
                    enemy.customHp -= weaponDmg
                    enemy.setTexture('enemy-1-hit') //changes image when hit
                }
            }
        }

        //Drop exp function
        function dropExp(enemy){

        }
    </script>

    <!-- Styles that center the canvas and set scaling ot 0.5 -->
    <style>
        body{
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 0;
            margin: 0;
        }

        #stats{
            position: fixed;
            top: 24px;
            left: 24px;
        }

        p{
            margin: 0;
        }

        canvas{
            transform: scale(0.5);
        }
    </style>
</body>
</html>