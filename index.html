<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Army Of Morr</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
</head>
<body>
    <div id="stats">
        <p id="life"></p>
        <p id="time"></p>
    </div>

    <!-- Game code -->
    <script>
    //CONFIGURATION & VARIABLES
        var config = {
            type: Phaser.AUTO,
            width: 640,
            height: 1200,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: true,
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };
    
        var game = new Phaser.Game(config)
        var player, cursors, enemy

        //Player stats
        var playerStats = {
            life: 10,
            points: 0,
        }

    //PRELOAD
        function preload (){
            //Player
            this.load.image('player', './img/player.png')

            //Enemy
            this.load.image('enemy-1', './img/enemy-1.png')

            //Misc
            this.load.image('map', './img/map.png')
        }
    
    //CREATE
        function create (){
            //Variables for screen centre
            const screenCenterX = this.cameras.main.worldView.x + this.cameras.main.width / 2;
            const screenCenterY = this.cameras.main.worldView.y + this.cameras.main.height / 2;

            //Background image
            this.add.image(375, 812, 'map')

            //Player srite
            player = this.physics.add.sprite(screenCenterX, screenCenterY, 'player')
            player.setCollideWorldBounds(true);
            console.log(player)

            //Enemy sprites
            enemy = this.physics.add.group({
                key: 'enemy-1',
                repeat: 3,
                setXY: { x: 24, y: 24, stepX: 80, stepY: 12 },
                bounce: 1
            })

            console.log(enemy)

            //Keyboard keys
            cursors = this.input.keyboard.createCursorKeys()

            //Colliders
            this.physics.add.overlap(player, enemy, dmgPlayer, null, this);
        }
        
    //UPDATE
        function update (){
            //Points calculation function
            updateTime()

            //Player movement wihth keyboard
            if (cursors.left.isDown) {
                // player.x -= 3
                player.setVelocityX(-160)

                //Turn drift
                if(player.body.velocity.y > 0){
                    player.setVelocityY(player.body.velocity.y - 5)
                }
                else if (player.body.velocity.y < 0) {
                    player.setVelocityY(player.body.velocity.y + 5)
                }

            }
            else if (cursors.right.isDown) {
                player.setVelocityX(160)

                //Turn drift
                if(player.body.velocity.y > 0){
                    player.setVelocityY(player.body.velocity.y - 5)
                }
                else if (player.body.velocity.y < 0) {
                    player.setVelocityY(player.body.velocity.y + 5)
                }
            }
            else if (cursors.up.isDown) {
                player.setVelocityY(-160)

                if(player.body.velocity.x > 0){
                    player.setVelocityX(player.body.velocity.x - 5)
                }
                else if (player.body.velocity.x < 0) {
                    player.setVelocityX(player.body.velocity.x + 5)
                }
            }
            else if (cursors.down.isDown) {
                player.setVelocityY(160)

                if(player.body.velocity.x > 0){
                    player.setVelocityX(player.body.velocity.x - 5)
                } 
                else if (player.body.velocity.x < 0) {
                    player.setVelocityX(player.body.velocity.x + 5)
                }
            }
            else {
                player.setVelocityX(0)
                player.setVelocityY(0)
            }

            //Enemy movement
            enemy.children.entries.forEach(function(element){

                if (player.x > element.x){
                    element.x++
                }
                else if (player.x < element.x){
                    element.x--
                }
    
                if (player.y > element.y){
                    element.y++
                }
                else if (player.y < element.y){
                    element.y--
                }
            })
        }
    
    //GAME LOGIC
        //Show score
        var TimelastRun = 0
        var TimeDelay = 1000
        var timeText = document.getElementById('time')
        timeText.innerHTML = "0 point"

        function updateTime(){
            if (TimelastRun > (Date.now() - TimeDelay))
                //Timer
                return;
                TimelastRun = Date.now();

                //Update timer
                playerStats.points++
                timeText.innerHTML = playerStats.points + " points"
        }

        //Player damage
        var lastRun = 0
        var delay = 500
        var lifeText = document.getElementById('life')
        lifeText.innerHTML = playerStats.life //Set life value to obj value

        function dmgPlayer(player, enemy){
            
            //Prevent function from executing more than N times per sec.
            if (lastRun > (Date.now() - delay))
                //Timer
                return;
                lastRun = Date.now();
                
                //Reduce live
                playerStats.life--

                //Check if player is dead
                if(playerStats.life < 1){

                    //Reset player object
                    playerStats.life = 10
                    playerStats.points = 0

                    //Restart the game
                    this.scene.restart();
                }

                //Update html life label
                lifeText.innerHTML = playerStats.life

                //Change player colour to black on overlap
                player.tint = 0x121212

                //Reset player to white after delay
                setTimeout(function(){ player.tint = 0xffffff; }, 100);
        }
    </script>

    <!-- Styles that center the canvas and set scaling ot 0.5 -->
    <style>
        body{
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 0;
            margin: 0;
        }

        #stats{
            position: fixed;
            top: 24px;
            left: 24px;
        }

        p{
            margin: 0;
        }

        canvas{
            transform: scale(0.5);
        }
    </style>
</body>
</html>